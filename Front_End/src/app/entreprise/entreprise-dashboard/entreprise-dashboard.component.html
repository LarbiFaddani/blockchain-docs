<div class="layout">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="sidebar-logo">
        <div class="logo-icon">
          <span class="material-icons">business</span>
        </div>     
        
        <div class="logo-text">
        <h2>DocsBlockchain</h2>
        <p>Espace Entreprise</p>
      </div>
    </div>

    <ul class="nav-menu">
      <li class="nav-item">
        <button class="nav-link" type="button"
                [class.active]="activePage === 'verification'"
                (click)="showPage('verification')">
          <span>V√©rification</span>
        </button>
      </li>

      <li class="nav-item">
        <button class="nav-link" type="button"
                [class.active]="activePage === 'profile'"
                (click)="showPage('profile')">
          <span>Mon Profil</span>
        </button>
      </li>
    </ul>

    <div class="user-section">
      <div class="user-info">
        <div class="user-avatar">{{ profileInitials }}</div>
        <div class="user-details">
          <h4>{{ myEntreprise?.name || '‚Äî' }}</h4>
          <p>{{ myEntreprise?.emailContact || '‚Äî' }}</p>
        </div>
      </div>

      <button class="btn-logout" type="button" (click)="logout()">
        <span>D√©connexion</span>
      </button>
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main-content">

    <!-- PAGE: VERIFICATION -->
    <section *ngIf="activePage === 'verification'">
      <header class="header">
        <h1>V√©rification de Documents</h1>
        <p class="subtitle">V√©rifiez l'authenticit√© des documents sur la blockchain</p>
      </header>

      <div class="content">
        <div class="verification-container">

          <!-- Panel Upload -->
          <div class="panel">
            <div class="panel-header">
              <h2>üì§ Upload Document</h2>
              <p>Glissez-d√©posez ou s√©lectionnez un fichier √† v√©rifier</p>
            </div>

            <div class="banner error" *ngIf="errorMessage">
              <span class="b-ico">‚ö†Ô∏è</span>
              <span>{{ errorMessage }}</span>
            </div>

            <div class="upload-zone"
                 [class.dragover]="isDragOver"
                 (dragover)="onDragOver($event)"
                 (dragleave)="onDragLeave($event)"
                 (drop)="onDrop($event)"
                 (click)="openFilePicker()"
                 role="button" tabindex="0">

              <div class="upload-icon">üìÑ</div>
              <h3>Glissez-d√©posez votre fichier</h3>
              <p>ou cliquez pour parcourir</p>

              <button class="btn-upload" type="button"
                      (click)="openFilePicker(); $event.stopPropagation()">
                Choisir un fichier
              </button>

              <p class="file-types">PDF, DOCX, PNG, JPG (Max 10MB)</p>

              <input #fileInput type="file" class="file-input"
                     accept=".pdf,.docx,.png,.jpg,.jpeg"
                     (change)="onFileSelected($event)" />
            </div>

            <div class="uploaded-file" [class.show]="selectedFile">
              <div class="file-icon-display">üìã</div>
              <div class="file-info">
                <h4>{{ selectedFile?.name }}</h4>
                <p>{{ fileSizeLabel }}</p>
              </div>
              <button class="btn-remove" type="button" (click)="removeFile()">‚úï</button>
            </div>

            <button class="btn-verify" type="button"
                    [class.show]="!!selectedFile"
                    [disabled]="isVerifying || !selectedFile"
                    (click)="verifyDocument()">
              {{ isVerifying ? 'V√©rification...' : 'üîç V√©rifier l‚Äôauthenticit√©' }}
            </button>
          </div>

          <!-- Panel Results -->
          <div class="panel">
            <div class="panel-header">
              <h2>üìä R√©sultats</h2>
              <p>Informations de v√©rification blockchain</p>
            </div>

            <div class="results-empty" *ngIf="!isVerifying && !hasResult">
              <div class="empty-icon">üîç</div>
              <h3>En attente</h3>
              <p>Uploadez un document pour commencer</p>
            </div>

            <div class="loading" [class.show]="isVerifying">
              <div class="spinner"></div>
              <p>V√©rification sur la blockchain...</p>
            </div>

            <div class="results-content" [class.show]="hasResult && !isVerifying" *ngIf="verifyResponse">
              <div class="status-header">
                <div class="status-icon" [class.verified]="isValid" [class.invalid]="!isValid">
                  {{ isValid ? '‚úì' : '‚úï' }}
                </div>

                <h2 [class.verified]="isValid" [class.invalid]="!isValid">
                  {{ isValid ? 'Document Authentique' : 'Document Non Authentique' }}
                </h2>

                <p class="status-msg">{{ verifyResponse.message }}</p>

                <button *ngIf="verifyResponse?.downloadUrl"
                        class="btn-download" type="button"
                        (click)="ddownload(verifyResponse.downloadUrl!)">
                  ‚¨áÔ∏è T√©l√©charger le document
                </button>
              </div>

              <!-- ‚úÖ Infos -->
              <div class="info-card"> 
                <!-- <div class="info-row">
                  <span class="info-label">OrgId</span>
                  <span class="info-value">{{ verifyResponse.orgId ?? '‚Äî' }}</span>
                </div>  -->

                <div class="info-row">
                  <span class="info-label">√âcole</span>
                  <span class="info-value">{{ verifiedEcole?.name || '‚Äî' }}</span>
                </div>

                <!-- <div class="info-row">
                  <span class="info-label">UserId</span>
                  <span class="info-value">{{ verifyResponse.userId ?? '‚Äî' }}</span>
                </div> -->

                <div class="info-row">
                  <span class="info-label">Type Document</span>
                  <span class="info-value">{{ verifyResponse.docType ?? '‚Äî' }}</span>
                </div>

                <!-- ‚úÖ NOUVEAU: √âtudiant -->
                <div class="info-row">
                  <span class="info-label">√âtudiant</span>
                  <span class="info-value">
                    {{ verifiedStudent ? (verifiedStudent.lastName + ' ' + verifiedStudent.firstName) : '‚Äî' }}
                  </span>
                </div>

                <div class="info-row">
                  <span class="info-label">CIN</span>
                  <span class="info-value">{{ verifiedStudent?.cin || '‚Äî' }}</span>
                </div>

                <div class="info-row">
                  <span class="info-label">Code √©tudiant</span>
                  <span class="info-value">{{ verifiedStudent?.studentCode || '‚Äî' }}</span>
                </div>

                <div class="info-row">
                  <span class="info-label">Statut compte</span>
                  <span class="info-value">
                    {{
                      verifiedStudent?.enabled === true ? 'Actif' :
                      verifiedStudent?.enabled === false ? 'D√©sactiv√©' : '‚Äî'
                    }}
                  </span>
                </div>
              </div>

              <button class="btn-new" type="button" (click)="resetVerification()">
                üîÑ V√©rifier un autre document
              </button>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- PAGE: PROFIL -->
    <section *ngIf="activePage === 'profile'">
      <header class="header">
        <h1>Mon Profil</h1>
        <p class="subtitle">Informations de l‚Äôentreprise li√©e √† votre compte</p>
      </header>

      <div class="content">
        <div class="profile-container">
          <div class="profile-card">

            <div class="profile-header">
              <div class="profile-avatar">{{ profileInitials }}</div>
              <div class="profile-info">
                <h2>{{ myEntreprise?.name || '‚Äî' }}</h2>
                <p>{{ myEntreprise?.city || '‚Äî' }}</p>
              </div>
            </div>

            <div class="banner error" *ngIf="profileError">
              <span class="b-ico">‚ö†Ô∏è</span>
              <span>{{ profileError }}</span>
            </div>

            <div class="banner success" *ngIf="saveSuccess">
              <span class="b-ico">‚úÖ</span>
              <span>{{ saveSuccess }}</span>
            </div>

            <div class="banner error" *ngIf="saveError">
              <span class="b-ico">‚ö†Ô∏è</span>
              <span>{{ saveError }}</span>
            </div>

            <div class="loading show" *ngIf="loadingProfile">
              <div class="spinner"></div>
              <p>Chargement du profil‚Ä¶</p>
            </div>

            <!-- VIEW MODE -->
            <div class="info-card" *ngIf="!loadingProfile && myEntreprise && !editMode">
              <div class="info-row">
                <span class="info-label">Email contact</span>
                <span class="info-value">{{ myEntreprise.emailContact || '‚Äî' }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Adresse</span>
                <span class="info-value">{{ myEntreprise.address || '‚Äî' }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">ID Entreprise</span>
                <span class="info-value">{{ myEntreprise.id || '‚Äî' }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">ICE</span>
                <span class="info-value">{{ myEntreprise.ice || '‚Äî' }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Secteur d‚Äôactivit√©</span>
                <span class="info-value">{{ myEntreprise.secteurActivite || '‚Äî' }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Statut juridique</span>
                <span class="info-value">{{ myEntreprise.statutJuridique || '‚Äî' }}</span>
              </div>

              <div class="btn-row">
                <button class="btn-primary" type="button" (click)="startEdit()">‚úèÔ∏è Modifier</button>
                <button class="btn-secondary" type="button" (click)="loadMyProfile()" [disabled]="loadingProfile">‚Üª Rafra√Æchir</button>
              </div>
            </div>

            <!-- EDIT MODE -->
            <div class="info-card" *ngIf="!loadingProfile && myEntreprise && editMode">

              <div class="form-grid">
                <div class="form-field">
                  <label>Nom</label>
                  <input class="input" [(ngModel)]="entrepriseForm.name" name="name" type="text" />
                </div>

                <div class="form-field">
                  <label>Email</label>
                  <input class="input" [(ngModel)]="entrepriseForm.emailContact" name="emailContact" type="email" />
                </div>

                <div class="form-field">
                  <label>Ville</label>
                  <input class="input" [(ngModel)]="entrepriseForm.city" name="city" type="text" />
                </div>

                <div class="form-field">
                  <label>Adresse</label>
                  <input class="input" [(ngModel)]="entrepriseForm.address" name="address" type="text" />
                </div>

                <div class="form-field">
                  <label>ICE</label>
                  <input class="input" [(ngModel)]="entrepriseForm.ice" name="ice" type="text" />
                </div>

                <div class="form-field">
                  <label>Secteur</label>
                  <input class="input" [(ngModel)]="entrepriseForm.secteurActivite" name="secteurActivite" type="text" />
                </div>

                <div class="form-field">
                  <label>Statut</label>
                  <input class="input" [(ngModel)]="entrepriseForm.statutJuridique" name="statutJuridique" type="text" />
                </div>
              </div>

              <div class="btn-row">
                <button class="btn-primary" type="button" (click)="saveEntreprise()" [disabled]="savingProfile">
                  {{ savingProfile ? 'Enregistrement...' : 'üíæ Enregistrer' }}
                </button>

                <button class="btn-secondary" type="button" (click)="cancelEdit()" [disabled]="savingProfile">
                  Annuler
                </button>
              </div>
            </div>

            <div class="info-card" *ngIf="!loadingProfile && !myEntreprise && !profileError">
              <p class="muted">Aucune entreprise trouv√©e pour ce compte.</p>
              <button class="btn-secondary" type="button" (click)="loadMyProfile()">‚Üª R√©essayer</button>
            </div>

          </div>
        </div>
      </div>
    </section>

  </main>
</div>
