<div class="documents-page full">
  <div class="page-head">
    <div>
      <h2>Documents</h2>
      <p>Historique de votre organisation</p>
    </div>
  </div>

  <!-- BANNERS -->
  <div class="banner success" *ngIf="successMessage">{{ successMessage }}</div>
  <div class="banner error" *ngIf="errorMessage">{{ errorMessage }}</div>

  <!-- TOP CARDS -->
  <div class="top-grid">
    <!-- Add card with illustration -->
    <div class="add-card" (click)="openModal()" role="button" tabindex="0">
      <div class="add-left">
        <div class="kicker" style="color: black;">Ajouter</div>
        <h3>Nouveau document</h3>
        <p>Uploadez un document et enregistrez-le sur la blockchain.</p>
        <button class="btn-primary mini" style="color: black;" type="button" (click)="openModal(); $event.stopPropagation()">
          ï¼‹ Ajouter document
        </button>
      </div>
      <div class="add-illus" aria-hidden="true"></div>
    </div>

    <!-- Stats / org -->
    <div class="stat-card">
      <div class="stat-head">
        <h3>RÃ©sumÃ©</h3>
        <span class="pill" *ngIf="orgId">OrgId: {{ orgId }}</span>
        <span class="pill ghost" *ngIf="!orgId">RÃ©cupÃ©rationâ€¦</span>
      </div>

      <div class="stat-body">
        <div class="stat-line">
          <div class="label">Total documents</div>
          <div class="value">{{ totalDocs }}</div>
        </div>

        <div class="stat-line">
          <div class="label">Ã‰tat</div>
          <div class="value">
            <span class="badge" *ngIf="isResolvingOrg || isLoadingDocs">Chargement</span>
            <span class="badge ok" *ngIf="!isResolvingOrg && !isLoadingDocs && documentsLoaded">Ã€ jour</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- LISTE DOCUMENTS -->
  <div class="panel">
    <div class="panel-header">
      <h2>ðŸ“š Documents</h2>
      <p *ngIf="orgId">Organisation: {{ orgId }}</p>
      <p *ngIf="!orgId">RÃ©cupÃ©ration de lâ€™organisationâ€¦</p>
    </div>

    <!-- loader -->
    <div class="loading" *ngIf="isResolvingOrg || isLoadingDocs">
      <div class="spinner"></div>
      <p>Chargementâ€¦</p>
    </div>

    <!-- table -->
    <div class="table-wrap"
         *ngIf="documentsLoaded && !isResolvingOrg && !isLoadingDocs && documents.length > 0">
      <table class="docs-table">
        <thead>
          <tr>
            <th style="width:90px;">ID</th>
            <th style="width:220px;">Type</th>
            <th style="width:120px;">Ã‰tudiant</th>
            <th style="width:190px;">Date</th>
            <th>Tx</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let d of documents">
            <td class="strong">{{ d.id }}</td>
            <td>{{ d.docType || 'â€”' }}</td>
            <td class="muted">{{ d.userId || 'â€”' }}</td>
            <td class="muted">{{ d.createdAt || 'â€”' }}</td>
            <td><span class="mono">{{ d.blockchainTx || 'â€”' }}</span></td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- empty state -->
    <div class="results-empty"
         *ngIf="documentsLoaded && !isResolvingOrg && !isLoadingDocs && documents.length === 0">
      <div class="empty-icon">ðŸ“­</div>
      <h3>Aucun document</h3>
      <p>Aucun document trouvÃ© pour votre organisation.</p>
      <button class="btn-primary" type="button" (click)="openModal()">ï¼‹ Ajouter votre premier document</button>
    </div>
  </div>
</div>

<!-- MODAL OVERLAY -->
<div class="overlay" *ngIf="isModalOpen" (click)="onOverlayClick($event)">
  <div class="modal-card" (click)="onModalClick($event)">
    <div class="modal-head">
      <h3>Ajouter un document</h3>
        <button class="icon-close" type="button" (click)="closeModal()" [disabled]="isSubmitting">âœ•</button>
    </div>

    <form class="doc-form" [formGroup]="form" (ngSubmit)="submitCreateDocument()">
      <div class="row">
        <div class="field">
          <label>FiliÃ¨re</label>
          <select formControlName="filiereId" [disabled]="isLoadingFilieres || isSubmitting">
            <option value="">â€” SÃ©lectionner â€”</option>
            <option *ngFor="let f of filieres" [value]="f.id">{{ f.code }}</option>
          </select>
          <small class="hint" *ngIf="isLoadingFilieres">Chargement des filiÃ¨resâ€¦</small>
        </div>

        <div class="field">
          <label>Ã‰tudiant</label>
          <select formControlName="studentId"
                  [disabled]="isLoadingStudents || isSubmitting || studentsFiltered.length === 0">
            <option value="">â€” SÃ©lectionner â€”</option>
            <option *ngFor="let s of studentsFiltered" [value]="s.id">
              {{ s.lastName }} {{ s.firstName }} â€” {{ s.cin }}
            </option>
          </select>
          <small class="hint" *ngIf="isLoadingStudents">Chargement des Ã©tudiantsâ€¦</small>
          <small class="hint" *ngIf="!isLoadingStudents && studentsFiltered.length === 0">
            Choisissez une filiÃ¨re.
          </small>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Type de document</label>
          <select formControlName="docType" [disabled]="isSubmitting">
            <option value="">â€” SÃ©lectionner â€”</option>
            <option *ngFor="let t of docTypes" [value]="t.value">{{ t.label }}</option>
          </select>
        </div>
      </div>

      <div class="upload-zone" (click)="fileInput.click()">
        <div class="upload-icon">ðŸ“„</div>
        <h4>Choisir un fichier</h4>
        <p>PDF, DOCX, PNG, JPG (Max 10MB)</p>

        <input #fileInput type="file" class="file-input"
               accept=".pdf,.docx,.png,.jpg,.jpeg"
               (change)="onFileSelected($event)" />
      </div>

      <div class="uploaded-file" [class.show]="selectedFile">
        <div class="file-icon-display">ðŸ“‹</div>
        <div class="file-info">
          <h4>{{ selectedFile?.name }}</h4>
          <p>{{ selectedFile ? (selectedFile.size / 1024 / 1024 | number:'1.1-2') + ' MB' : '' }}</p>
        </div>
        <button type="button" class="btn-remove" (click)="removeFile()">âœ•</button>
      </div>

      <div class="actions">
        <button type="submit" class="btn-primary"
                [disabled]="isSubmitting || form.invalid || !selectedFile">
          {{ isSubmitting ? 'Uploadâ€¦' : 'Uploader' }}
        </button>

        <button type="button" class="btn-secondary"
                (click)="resetForm()" [disabled]="isSubmitting">
          RÃ©initialiser
        </button>
      </div>

      <div class="form-error" *ngIf="form.touched && form.invalid">
        Merci de remplir tous les champs.
      </div>
    </form>
  </div>
</div>
