<div class="documents-page">
  <div class="page-head">
    <h2>Documents</h2>
    <p>Enregistrer et vÃ©rifier des documents sur la blockchain</p>
  </div>

  <!-- BANNERS -->
  <div class="banner success" *ngIf="successMessage">{{ successMessage }}</div>
  <div class="banner error" *ngIf="errorMessage">{{ errorMessage }}</div>

  <div class="verification-container">
    <!-- =================== LEFT: FORM + UPLOAD =================== -->
    <div class="panel">
      <div class="panel-header">
        <h2>ğŸ“¤ Upload Document</h2>
        <p>Choisissez lâ€™Ã©tudiant, le type du document, puis uploadez le fichier</p>
      </div>

      <form class="doc-form" [formGroup]="form" (ngSubmit)="submitCreateDocument()">
        <!-- FiliÃ¨re -->
        <div class="field">
          <label>FiliÃ¨re</label>
          <select formControlName="filiereId" [disabled]="isLoadingFilieres">
            <option value="">â€” SÃ©lectionner une filiÃ¨re â€”</option>
            <option *ngFor="let f of filieres" [value]="f.id">{{ f.code }}</option>
          </select>
          <small class="hint" *ngIf="isLoadingFilieres">Chargement des filiÃ¨resâ€¦</small>
          <small class="hint" *ngIf="!isLoadingFilieres">Le choix de la filiÃ¨re filtre la liste des Ã©tudiants.</small>
        </div>

        <!-- Ã‰tudiant -->
        <div class="field">
          <label>Ã‰tudiant</label>
          <select
            formControlName="studentId"
            [disabled]="isLoadingStudents || studentsFiltered.length === 0">
            <option value="">â€” SÃ©lectionner un Ã©tudiant â€”</option>
            <option *ngFor="let s of studentsFiltered" [value]="s.id">
              {{ s.lastName }} {{ s.firstName }} â€” {{ s.cin }}
            </option>
          </select>

          <small class="hint" *ngIf="isLoadingStudents">Chargement des Ã©tudiantsâ€¦</small>
          <small class="hint" *ngIf="!isLoadingStudents && studentsFiltered.length === 0">
            SÃ©lectionne une filiÃ¨re pour afficher les Ã©tudiants.
          </small>
        </div>

        <!-- Type document -->
        <div class="field">
          <label>Type de document</label>
          <input
            type="text"
            formControlName="docType"
            placeholder="Ex: Attestation de scolaritÃ©, DiplÃ´me, RelevÃ© de notes..." />
        </div>

        <!-- Upload zone -->
        <div class="upload-zone" (click)="fileInput.click()">
          <div class="upload-icon">ğŸ“„</div>
          <h3>Glissez-dÃ©posez votre fichier</h3>
          <p>ou cliquez pour parcourir</p>

          <button
            type="button"
            class="btn-upload"
            (click)="fileInput.click(); $event.stopPropagation()">
            Choisir un fichier
          </button>

          <p class="file-types">PDF, DOCX, PNG, JPG (Max 10MB)</p>

          <input
            #fileInput
            type="file"
            class="file-input"
            accept=".pdf,.docx,.png,.jpg,.jpeg"
            (change)="onFileSelected($event)" />
        </div>

        <!-- File preview -->
        <div class="uploaded-file" [class.show]="selectedFile">
          <div class="file-icon-display">ğŸ“‹</div>
          <div class="file-info">
            <h4>{{ selectedFile?.name }}</h4>
            <p>{{ selectedFile ? (selectedFile.size / 1024 / 1024 | number:'1.1-2') + ' MB' : '' }}</p>
          </div>
          <button type="button" class="btn-remove" (click)="removeFile()">âœ•</button>
        </div>

        <!-- Submit -->
        <button
          type="submit"
          class="btn-verify"
          [class.show]="selectedFile && !isSubmitting"
          [disabled]="isSubmitting || form.invalid || !selectedFile">
          {{ isSubmitting ? 'Traitementâ€¦' : 'â›“ï¸ Enregistrer sur la blockchain' }}
        </button>

        <div class="form-error" *ngIf="form.touched && form.invalid">
          Merci de sÃ©lectionner une filiÃ¨re, un Ã©tudiant et un type de document.
        </div>
      </form>
    </div>

    <!-- =================== RIGHT: RESULTS =================== -->
    <div class="panel">
      <div class="panel-header">
        <h2>ğŸ“Š RÃ©sultats</h2>
        <p>Informations de vÃ©rification blockchain</p>
      </div>

      <!-- Empty -->
      <div class="results-empty" *ngIf="!selectedFile && !isSubmitting && !result">
        <div class="empty-icon">ğŸ”</div>
        <h3>En attente</h3>
        <p>Choisissez un Ã©tudiant et uploadez un document pour commencer</p>
      </div>

      <!-- Loading -->
      <div class="loading" [class.show]="isSubmitting">
        <div class="spinner"></div>
        <p>Enregistrement et transaction blockchainâ€¦</p>
      </div>

      <!-- Results -->
      <div class="results-content" [class.show]="!!result && !isSubmitting" *ngIf="result">
        <div class="status-header">
          <div class="status-icon" [ngClass]="result.valid ? 'verified' : 'invalid'">
            {{ result.valid ? 'âœ“' : 'âœ•' }}
          </div>
          <h2 [ngClass]="result.valid ? 'verified' : 'invalid'">
            {{ result.valid ? 'Document enregistrÃ©' : 'Ã‰chec' }}
          </h2>
          <p>{{ result.message }}</p>
        </div>

        <div class="info-card" *ngIf="result.meta">
          <div class="info-row">
            <span class="info-label">Ã‰tudiant</span>
            <span class="info-value">{{ result.meta.studentName }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">CIN</span>
            <span class="info-value">{{ result.meta.studentCin }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">FiliÃ¨re</span>
            <span class="info-value">{{ result.meta.filiereName }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Type Document</span>
            <span class="info-value">{{ result.meta.docType }}</span>
          </div>
        </div>

        <div class="info-card">
          <div class="info-row">
            <span class="info-label">Transaction</span>
            <span class="info-value mono">{{ result.blockchainTx || 'â€”' }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Bloc</span>
            <span class="info-value">{{ result.blockNumber ?? 'â€”' }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">RÃ©seau</span>
            <span class="info-value">
              <span class="blockchain-badge">
                <span>â›“ï¸</span>
                <span>{{ result.network || 'Ganache' }}</span>
              </span>
            </span>
          </div>
          <div class="info-row">
            <span class="info-label">Timestamp</span>
            <span class="info-value">{{ result.timestamp || 'â€”' }}</span>
          </div>
        </div>

        <button type="button" class="btn-new" (click)="resetVerification()">
          ğŸ”„ Nouveau document
        </button>
      </div>
    </div>
  </div>
</div>
